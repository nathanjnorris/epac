name: 'Create Compliance Issue from Logs'

on:
  workflow_dispatch:
    inputs:
      workflow_run_id:
        description: 'The workflow run ID to extract compliance data from'
        required: true
        type: string

permissions:
  issues: write
  contents: read
  actions: read

jobs:
  create-compliance-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download workflow logs
        run: |
          echo "Downloading logs for workflow run ID: ${{ inputs.workflow_run_id }}"
          
          # Download the workflow run logs using GitHub CLI
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/actions/runs/${{ inputs.workflow_run_id }}/logs" \
            > workflow_logs.zip
          
          # Extract the zip file
          unzip -q workflow_logs.zip
          
          # Combine all log files into one for easier parsing
          find . -name "*.txt" -type f -exec cat {} \; > combined_logs.txt
          
          echo "=== Log file info ==="
          ls -la combined_logs.txt
          echo "Log file size: $(wc -c < combined_logs.txt) bytes"
          echo "Log file lines: $(wc -l < combined_logs.txt) lines"
          
          echo "=== Searching for compliance-related content ==="
          grep -n -i "compliance\|policy\|noncompliant" combined_logs.txt | head -10 || echo "No compliance keywords found in preview"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Extract compliance table from logs
        id: extract-compliance
        run: |
          echo "Searching for compliance tables in workflow logs..."
          
          COMPLIANCE_FOUND=false
          ENVIRONMENT_RESULTS=""
          
          # Process each log file separately to identify which environment has issues
          for log_file in $(find . -name "*.txt" -type f | sort); do
            echo "=== Analyzing log file: $log_file ==="
            
            # Determine environment from filename
            ENVIRONMENT=""
            if [[ "$log_file" == *"epac-dev"* ]]; then
              ENVIRONMENT="epac-dev"
            elif [[ "$log_file" == *"tenant"* ]]; then
              ENVIRONMENT="tenant"
            else
              # Try to extract environment from file content if filename doesn't indicate
              if grep -q "Environment Selected: epac-dev" "$log_file"; then
                ENVIRONMENT="epac-dev"
              elif grep -q "Environment Selected: tenant" "$log_file"; then
                ENVIRONMENT="tenant"
              else
                ENVIRONMENT="unknown"
              fi
            fi
            
            echo "Processing environment: $ENVIRONMENT"
            
            # Look for compliance table in this specific file
            if grep -q "Policy compliance scan report\|‚ïî.*‚ïó" "$log_file"; then
              echo "Found compliance table in $ENVIRONMENT environment"
              
              # Extract from "Policy compliance scan report" to the end of the table (‚ïö.*‚ïù)
              TABLE_CONTENT=$(sed -n '/Policy compliance scan report/,/‚ïö.*‚ïù/p' "$log_file")
              
              if [ -n "$TABLE_CONTENT" ]; then
                # Strip timestamps from each line (format: YYYY-MM-DDTHH:MM:SS.XXXXXXXZ)
                CLEANED_TABLE=$(echo "$TABLE_CONTENT" | sed 's/^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}T[0-9]\{2\}:[0-9]\{2\}:[0-9]\{2\}\.[0-9]\{7\}Z //')
                
                # Add environment section to results
                ENVIRONMENT_RESULTS="${ENVIRONMENT_RESULTS}

          ## Environment: ${ENVIRONMENT}

          \`\`\`
          ${CLEANED_TABLE}
          \`\`\`
          "
                COMPLIANCE_FOUND=true
                echo "‚úÖ Successfully extracted compliance table for $ENVIRONMENT ($(echo "$CLEANED_TABLE" | wc -l) lines)"
                echo "Table preview (first 3 lines):"
                echo "$CLEANED_TABLE" | head -3
              fi
            else
              echo "No compliance issues found in $ENVIRONMENT environment"
            fi
          done
          
          # Save results
          if [ "$COMPLIANCE_FOUND" = true ]; then
            {
              echo 'compliance-data<<EOF'
              echo "$ENVIRONMENT_RESULTS"
              echo 'EOF'
            } >> $GITHUB_OUTPUT
            echo "has-compliance-data=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Compliance data extracted from multiple environments"
          else
            echo "‚ùå No compliance tables found in any environment"
            echo "has-compliance-data=false" >> $GITHUB_OUTPUT
            echo "compliance-data=No compliance tables found in any environment logs" >> $GITHUB_OUTPUT
            
            # Basic debugging
            echo "=== Debug: Searching for table markers across all files ==="
            for log_file in $(find . -name "*.txt" -type f); do
              echo "File: $log_file"
              echo "  Lines containing 'Policy compliance scan report':"
              grep -n "Policy compliance scan report" "$log_file" || echo "    Not found"
              echo "  Lines containing table borders '‚ïî':"
              grep -n "‚ïî" "$log_file" || echo "    Not found"
            done
          fi

      - name: Create GitHub issue
        if: steps.extract-compliance.outputs.has-compliance-data == 'true'
        run: |
          echo "Creating GitHub issue with compliance findings..."
          
          # Create the issue body
          cat << 'EOF' > issue_body.md
          ## üìä Policy Compliance Issues

          **Source Workflow:** [${{ inputs.workflow_run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ inputs.workflow_run_id }})  
          **Detected:** $(date -u '+%Y-%m-%d %H:%M UTC')

          ### üö® Non-Compliant Resources by Environment

          The following environments have non-compliant resources after remediation:

          ${{ steps.extract-compliance.outputs.compliance-data }}

          ### üìã Next Steps

          1. **Review each environment** listed above for non-compliant resources
          2. **Check environment-specific issues:**
             - Verify policy assignments are correctly configured for each environment
             - Check if resources require manual remediation
             - Review environment-specific exclusions or exemptions
          3. **Consider environment-specific actions:**
             - Update resource configurations to meet policy requirements
             - Apply policy exemptions if business-justified
             - Verify policy definitions work correctly across all environments
          4. **Monitor compliance status** after making changes

          ### üîç Environment-Specific Guidance

          - **epac-dev**: Development environment compliance issues may indicate policy testing needs
          - **tenant**: Production tenant issues require immediate attention and careful remediation

          ---
          *This issue was automatically created from workflow logs. Close when all compliance issues across all environments are resolved.*
          EOF

          # Create the issue using GitHub CLI
          gh issue create \
            --title "üö® Policy Compliance Issues Detected Across Environments" \
            --body-file issue_body.md \
            --label "PolicyCompliance" \
          && echo "‚úÖ GitHub issue created successfully" \
          || echo "‚ùå Failed to create GitHub issue"
        env:
            GH_TOKEN: ${{ github.token }}

      - name: Log summary
        run: |
          if [ "${{ steps.extract-compliance.outputs.has-compliance-data }}" == "true" ]; then
            echo "‚úÖ Successfully created multi-environment compliance issue"
            echo "üìä Found compliance data across environments and created GitHub issue"
          else
            echo "‚ÑπÔ∏è  No compliance issues found in any environment"
            echo "üéâ All resources across all environments appear to be compliant!"
          fi